%================================
%=  Rustler Stefan, 2014        =
%=  <rustlers@student.ethz.ch>  =
%================================
% 
% Notes:
% - This function gets an analytical expression for R_powsum(t) from
%   Phi_powsum(t), i.e. the PL-approximation via a sum of exponentials as
%   described in [1]. Phi_powsum(t) was explicitly formulated with the help
%   of Mathematica (file: 'Notes/powsum.nb'). As in [1] we set [m M] = [5
%   15], such that e.g. 5^15 = 6103515625.
% - This function calls INVLAP as it perferms better than the built-in
%   ilaplace.
% - The 'precision' of INVLAP is per default set to 500, i.e. The s-range
%   will be divided into 500*wtmax (s. Input) intervals for evaluation. To
%   improve the performance of INVLAP increase precision and/or wtmax. Note
%   that this may SIGNIFICANTLY computation time. 
%
%   [1]: S. J. Hardiman, N. Bercot, J. P. Bouchaud. "Critical reflexivity in
%        financial markets: a Hawkes process analysis". The European Physical 
%        Journal B 86 (10), 1-9 (2013).  
%
% Input:
% - params = [mu n c theta], where mu is not needed in here.
% - wtmax: Maximal waiting time as upper bound for the inverse Laplace
%   transformtion. R_powsum(t) will be from t \in [0;wtmax].
%
% Output:
% - tt: Time stamps for which R_powsum is calculated, i.e. R(t)=R_powsum(tt).
% - R_powsum: Value for tt according to R(t)=R_powsum(tt).
% - msg: Message containing information on the perfomance of this function,
%   i.e. calculation duration and theoretical integration-value of R(t) which
%   is 1/(1-n).
%
function [tt,R_powsum,msg] = get_Rpowsum(params,wtmax)
    precision = 10;
    start = tic;
    n = params(2);
    c = params(3);
    theta = params(4);
    syms s t

    phi_powsum = ...
        (...
             6103515625^(-1-theta) * c^(-1-theta) * exp((-c-t)/(6103515625*c))...
            +1220703125^(-1-theta) * c^(-1-theta) * exp((-c-t)/(1220703125*c))...
            +244140625^(-1-theta)  * c^(-1-theta) * exp((-c-t)/(244140625*c))...
            +48828125^(-1-theta)   * c^(-1-theta) * exp((-c-t)/(48828125*c))...
            +9765625^(-1-theta)    * c^(-1-theta) * exp((-c-t)/(9765625*c))...
            +1953125^(-1-theta)    * c^(-1-theta) * exp((-c-t)/(1953125*c))...
            +390625^(-1-theta) * c^(-1-theta) * exp((-c-t)/(390625*c))...
            +78125^(-1-theta)  * c^(-1-theta) * exp((-c-t)/(78125*c))...
            +15625^(-1-theta)  * c^(-1-theta) * exp((-c-t)/(15625*c))...
            +3125^(-1-theta)   * c^(-1-theta) * exp((-c-t)/(3125*c))...
            +625^(-1-theta)    * c^(-1-theta) * exp((-c-t)/(625*c))...
            +125^(-1-theta)    * c^(-1-theta) * exp((-c-t)/(125*c))...
            +25^(-1-theta)     * c^(-1-theta) * exp((-c-t)/(25*c))...
            +5^(-1-theta)      * c^(-1-theta) * exp((-c-t)/(5*c))...
            +1                 * c^(-1-theta) * exp((-c-t)/c)...
            - exp((5*(-c-t))/c)*...
               (...
                                      c^(-1-theta)...
                    +5^(-1-theta)   * c^(-1-theta)...
                    +25^(-1-theta)  * c^(-1-theta)...
                    +125^(-1-theta) * c^(-1-theta)...
                    +625^(-1-theta) * c^(-1-theta)...
                    +3125^(-1-theta)* c^(-1-theta)...
                    +15625^(-1-theta)    * c^(-1-theta)...
                    +78125^(-1-theta)    * c^(-1-theta)...
                    +390625^(-1-theta)   * c^(-1-theta)...
                    +1953125^(-1-theta)  * c^(-1-theta)...
                    +9765625^(-1-theta)  * c^(-1-theta)...
                    +48828125^(-1-theta) * c^(-1-theta)...
                    +244140625^(-1-theta)* c^(-1-theta)...
                    +1220703125^(-1-theta)       * c^(-1-theta)...
                    +6103515625^(-1-theta)       * c^(-1-theta)...
                )...
        )/(...
            -c/(5*exp(5))* ...
            (...
                 c^(-1-theta)...
                +5^(-1-theta)     * c^(-1-theta)...
                +25^(-1-theta)    * c^(-1-theta)...
                +125^(-1-theta)   * c^(-1-theta)...
                +625^(-1-theta)   * c^(-1-theta)...
                +3125^(-1-theta)  * c^(-1-theta)...
                +15625^(-1-theta) * c^(-1-theta)...
                +78125^(-1-theta) * c^(-1-theta)...
                +390625^(-1-theta)     *c^(-1-theta)...
                +1953125^(-1-theta)    * c^(-1-theta)...
                +9765625^(-1-theta)    * c^(-1-theta)...
                +48828125^(-1-theta)   * c^(-1-theta)...
                +244140625^(-1-theta)  * c^(-1-theta)...
                +1220703125^(-1-theta) * c^(-1-theta)...
                +6103515625^(-1-theta) * c^(-1-theta)...
            )...
            +(1             * c^-theta)/exp(1)...
            +(5^-theta      * c^-theta)/exp(1/5)...
            +(25^-theta     * c^-theta)/exp(1/25)...
            +(125^-theta    * c^-theta)/exp(1/125)...
            +(625^-theta    * c^-theta)/exp(1/625)...
            +(3125^-theta   * c^-theta)/exp(1/3125)...
            +(15625^-theta  * c^-theta)/exp(1/15625)...
            +(78125^-theta  * c^-theta)/exp(1/78125)...
            +(390625^-theta     * c^-theta)/exp(1/390625)...
            +(1953125^-theta    * c^-theta)/exp(1/1953125)...
            +(9765625^-theta    * c^-theta)/exp(1/9765625)...
            +(48828125^-theta   * c^-theta)/exp(1/48828125)...
            +(244140625^-theta  * c^-theta)/exp(1/244140625)...
            +(1220703125^-theta * c^-theta)/exp(1/1220703125)...
            +(6103515625^-theta * c^-theta)/exp(1/6103515625)...
        );
    phi_powsum_lap = laplace(phi_powsum,t,s); %The correctness of phi_powsum_lap was confirmed with 'phipowsumlap[s, 10, 0.5]' of the file 'GetAnalyticalRfrom-phi_powsum.nb'.
    R_powsum_lap = phi_powsum_lap / (1 - n * phi_powsum_lap);  
    
    %Simplify and ilaplace-transform:
    R_powsum_lap = simplify(R_powsum_lap,'Steps',10); %Simplify symbolic expression with 10 simplification steps.
    R_powsum_lap = vpa(R_powsum_lap); %Expresses big fractions as decimal numbers. This SIGNIFICANTLY accelerates the following ilaplace()-operation!
    [tt,R_powsum] = INVLAP(char(R_powsum_lap),-1,wtmax,precision*wtmax); %INVLAP performed better than the built-in ilaplace!
    
    %Just return R(t) for t>0:
    idx = find(tt>0); 
    R_powsum = R_powsum(idx(1):end); %This also prevents the case where R(0)-->Infinity.
    tt = tt(idx(1):end);
    
    %Produce performance message:
    binwidth = tt(2)-tt(1);
    area = sum(R_powsum)*binwidth; %Calculate the area of the R(t)-curve and compare it to its theoretical value (save in msg).
    ende = toc(start);
    msg = ['Calculating R_powsum(t) from Phi_powsum(t) took ',num2str(ende),' seconds.\nR(t) integrates to ',num2str(area),' with a theoretical value of 1/(1-n)=',num2str(1/(1-n)),'.\n'];
end

%% The following code has the same syntax as above but expresses R(t) as
%  the powsum-approximations. Note that R_powsum_lap =
%  laplace(phi_powsum)/(1-n*laplace(phi_powsum),t,s)
% 
%     First get an explicit expression of R_powsum_lap = laplace(phi_powsum)/(1-n*laplace(phi_powsum)):
%     R_powsum_lap = ... Rlap = orangeblock / (yellowblock - n*orangeblock)
%     (... Everything in these parantheses makes the "orange block"
%         ... First part of "orange block"
%         (6103515625^(-1 - theta) * c^(-1 - theta))/(exp(1/6103515625)*(1/(6103515625*c) + s)) + ...
%         (1220703125^(-1 - theta) * c^(-1 - theta))/(exp(1/1220703125)*(1/(1220703125*c) + s)) + ...
%         ( 244140625^(-1 - theta) * c^(-1 - theta))/(exp(1/ 244140625)*(1/(244140625*c) + s)) + ...
%         (  48828125^(-1 - theta) * c^(-1 - theta))/(exp(1/  48828125)*(1/(48828125*c) + s)) + ...
%         (   9765625^(-1 - theta) * c^(-1 - theta))/(exp(1/   9765625)*(1/(9765625*c) + s)) + ...
%         (   1953125^(-1 - theta) * c^(-1 - theta))/(exp(1/   1953125)*(1/(1953125*c) + s)) + ...
%         (    390625^(-1 - theta) * c^(-1 - theta))/(exp(1/    390625)*(1/(390625*c) + s)) + ...
%         (     78125^(-1 - theta) * c^(-1 - theta))/(exp(1/     78125)*(1/(78125*c) + s)) + ...
%         (     15625^(-1 - theta) * c^(-1 - theta))/(exp(1/     15625)*(1/(15625*c) + s)) + ...
%         (      3125^(-1 - theta) * c^(-1 - theta))/(exp(1/      3125)*(1/(3125*c) + s)) + ...
%         (       625^(-1 - theta) * c^(-1 - theta))/(exp(1/       625)*(1/(625*c) + s)) + ...
%         (       125^(-1 - theta) * c^(-1 - theta))/(exp(1/       125)*(1/(125*c) + s)) + ...
%         (        25^(-1 - theta) * c^(-1 - theta))/(exp(1/        25)*(1/(25*c) + s)) + ...
%         (         5^(-1 - theta) * c^(-1 - theta))/(exp(1/         5)*(1/(5*c) + s)) + ...
%         (         1              * c^(-1 - theta))/(exp(1/         1)*(1/ c + s)) - ...
%         1/(exp(5)*(5/c + s)) * ...
%         (... Second part of "orange block"
%             c^(-1 - theta) + ... 
%             5^(-1 - theta) * c^(-1 - theta) + ...
%             25^(-1 - theta) * c^(-1 - theta) + ...
%             125^(-1 - theta) * c^(-1 - theta) + ...
%             625^(-1 - theta) * c^(-1 - theta) + ...
%             3125^(-1 - theta) * c^(-1 - theta) + ...
%             15625^(-1 - theta) * c^(-1 - theta) + ...
%             78125^(-1 - theta) * c^(-1 - theta) + ...
%             390625^(-1 - theta) * c^(-1 - theta) + ...
%             1953125^(-1 - theta) * c^(-1 - theta) + ...
%             9765625^(-1 - theta) * c^(-1 - theta) + ...
%             48828125^(-1 - theta) * c^(-1 - theta) + ...
%             244140625^(-1 - theta) * c^(-1 - theta) + ...
%             1220703125^(-1 - theta) * c^(-1 - theta) + ...
%             6103515625^(-1 - theta) * c^(-1 - theta)...
%         )...
%     )/(... Big fraction line (Bruchstrich)
%         -c/(5*exp(5)) * ...
%         (... First part of "yellow block"
%             1             * c^(-1 - theta) + ... 
%             5^(-1 - theta) * c^(-1 - theta) + ...
%             25^(-1 - theta) * c^(-1 - theta) + ...
%             125^(-1 - theta) * c^(-1 - theta) + ...
%             625^(-1 - theta) * c^(-1 - theta) + ...
%             3125^(-1 - theta) * c^(-1 - theta) + ...
%             15625^(-1 - theta) * c^(-1 - theta) + ...
%             78125^(-1 - theta) * c^(-1 - theta) + ...
%             390625^(-1 - theta) * c^(-1 - theta) + ...
%             1953125^(-1 - theta) * c^(-1 - theta) + ...
%             9765625^(-1 - theta) * c^(-1 - theta) + ...
%             48828125^(-1 - theta) * c^(-1 - theta) + ...
%             244140625^(-1 - theta) * c^(-1 - theta) + ...
%             1220703125^(-1 - theta) * c^(-1 - theta) + ...
%             6103515625^(-1 - theta) * c^(-1 - theta)...
%         ) + ... Second part of "yellow block"
%             (                1 * c^-theta /exp(1)) + ...
%             (         5^-theta * c^-theta)/exp(1/5) + ... 
%             (        25^-theta * c^-theta)/exp(1/25) + ...
%             (       125^-theta * c^-theta)/exp(1/125) + ...
%             (       625^-theta * c^-theta)/exp(1/625) + ...
%             (      3125^-theta * c^-theta)/exp(1/3125) + ...
%             (     15625^-theta * c^-theta)/exp(1/15625) + ...
%             (     78125^-theta * c^-theta)/exp(1/78125) + ...
%             (    390625^-theta * c^-theta)/exp(1/390625) + ...
%             (   1953125^-theta * c^-theta)/exp(1/1953125) + ...
%             (   9765625^-theta * c^-theta)/exp(1/9765625) + ...
%             (  48828125^-theta * c^-theta)/exp(1/48828125) + ...
%             ( 244140625^-theta * c^-theta)/exp(1/244140625) + ...
%             (1220703125^-theta * c^-theta)/exp(1/1220703125) + ...
%             (6103515625^-theta * c^-theta)/exp(1/6103515625)...
%         - n * ... Branching ratio!
%         (... Everything in these parantheses makes the "yellow block"
%         ... First part of "orange block"
%             (6103515625^(-1 - theta) * c^(-1 - theta))/(exp(1/6103515625)*(1/(6103515625*c) + s)) + ...
%             (1220703125^(-1 - theta) * c^(-1 - theta))/(exp(1/1220703125)*(1/(1220703125*c) + s)) + ...
%             ( 244140625^(-1 - theta) * c^(-1 - theta))/(exp(1/244140625)*(1/(244140625*c) + s)) + ...
%             (  48828125^(-1 - theta) * c^(-1 - theta))/(exp(1/48828125)*(1/(48828125*c) + s)) + ...
%             (   9765625^(-1 - theta) * c^(-1 - theta))/(exp(1/9765625)*(1/(9765625*c) + s)) + ...
%             (   1953125^(-1 - theta) * c^(-1 - theta))/(exp(1/1953125)*(1/(1953125*c) + s)) + ...
%             (    390625^(-1 - theta) * c^(-1 - theta))/(exp(1/390625)*(1/(390625*c) + s)) + ...
%             (     78125^(-1 - theta) * c^(-1 - theta))/(exp(1/78125)*(1/(78125*c) + s)) + ...
%             (     15625^(-1 - theta) * c^(-1 - theta))/(exp(1/15625)*(1/(15625*c) + s)) + ...
%             (      3125^(-1 - theta) * c^(-1 - theta))/(exp(1/3125)*(1/(3125*c) + s)) + ...
%             (       625^(-1 - theta) * c^(-1 - theta))/(exp(1/625)*(1/(625*c) + s)) + ...
%             (       125^(-1 - theta) * c^(-1 - theta))/(exp(1/125)*(1/(125*c) + s)) + ...
%             (        25^(-1 - theta) * c^(-1 - theta))/(exp(1/25)*(1/(25*c) + s)) + ...
%             (         5^(-1 - theta) * c^(-1 - theta))/(exp(1/5)*(1/(5*c) + s)) + ...
%             (                     1) * c^(-1 - theta) /(exp(1)*(1/c + s)) - ...
%             1/(exp(5)*(5/c + s)) * ...
%             (... Second part of "orange block"
%                 1             * c^(-1 - theta) + ...
%                 5^(-1 - theta) * c^(-1 - theta) + ...
%                 25^(-1 - theta) * c^(-1 - theta) + ...
%                 125^(-1 - theta) * c^(-1 - theta) + ...
%                 625^(-1 - theta) * c^(-1 - theta) + ...
%                 3125^(-1 - theta) * c^(-1 - theta) + ...
%                 15625^(-1 - theta) * c^(-1 - theta) + ...
%                 78125^(-1 - theta) * c^(-1 - theta) + ...
%                 390625^(-1 - theta) * c^(-1 - theta) + ...
%                 1953125^(-1 - theta) * c^(-1 - theta) + ...
%                 9765625^(-1 - theta) * c^(-1 - theta) + ...
%                 48828125^(-1 - theta) * c^(-1 - theta) + ...
%                 244140625^(-1 - theta) * c^(-1 - theta) + ...
%                 1220703125^(-1 - theta) * c^(-1 - theta) + ...
%                 6103515625^(-1 - theta) * c^(-1 - theta)...
%             )...
%         )...
%     );
